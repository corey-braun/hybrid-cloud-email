# hybrid-cloud-email
A Hybrid-Cloud email server built with AWS and Docker. By using [Amazon SES](https://aws.amazon.com/ses/) as a backend for sending and receiving emails, this solution provides an alternative to the typical challenges/roadblocks of self-hosting email, such as:
- Sender reputation
- Blocked ports
- Non-static IP

Since this solution uses an infrastucture as code design, it is extremely easy to [deploy](#deployment) using [Docker Compose](https://docs.docker.com/compose/) and [AWS CloudFormation](https://aws.amazon.com/cloudformation/). Please note that after deployment & testing, you must [manually request production access to SES](#moving-out-of-the-ses-sandbox) to remove certain restrictions.

Light personal use of this solution is typically very [cheap](#pricing) thanks to AWS's free tier offerings and prorated billing.

## Table of contents
- [hybrid-cloud-email](#hybrid-cloud-email)
  - [Table of contents](#table-of-contents)
  - [How it works](#how-it-works)
    - [Sending mail](#sending-mail)
    - [Receiving mail](#receiving-mail)
  - [Requirements](#requirements)
  - [Deployment](#deployment)
    - [AWS](#aws)
    - [Docker](#docker)
    - [Moving out of the SES sandbox](#moving-out-of-the-ses-sandbox)
  - [Pricing](#pricing)
    - [SES](#ses)
    - [SNS](#sns)
    - [S3](#s3)

## How it works
In docker, you run an IMAP server, [Dovecot](https://www.dovecot.org/), and an SMTP server, [Postfix](https://www.postfix.org/).
These are the servers your email client interacts with to fetch/manage received emails and submit outgoing emails, respectively.

Behind the scenes, [Amazon SES](https://aws.amazon.com/ses/) handles interacting with other mail servers to deliver and receive your emails.
With Postfix, using SES to deliver outgoing mail is relatively simple to configure.
Getting received mail from AWS to Dovecot is a more complicated process, with an additional docker container needed as an abstraction layer between the two.

### Sending mail
Alpine-based Postfix Docker image [coreybraun/postfix-ses-relay](https://hub.docker.com/r/coreybraun/postfix-ses-relay) is used as your mail client's SMTP server. This container uses [Dovecot SASL](https://doc.dovecot.org/configuration_manual/howto/postfix_and_dovecot_sasl/) over docker networking to authenticate SMTP clients with the same credentials they use for IMAP.

After clients authenticate and submit a message, Postfix decides whether the client is allowed to use the address specified in the 'From:' field. This is done by matching the address against a [sender login map](https://www.postfix.org/postconf.5.html#smtpd_sender_login_maps), which can be generated by the container or supplied by you.

If this lookup returns the user's name, Postfix submits the email to Amazon SES using SMTP credentials [converted from an IAM access key and secret access key](https://docs.aws.amazon.com/ses/latest/dg/smtp-credentials.html#smtp-credentials-convert).

### Receiving mail
When Amazon SES receives email for your domain(s), the address in the 'To' field is matched against a [set of receipt rules](https://docs.aws.amazon.com/ses/latest/dg/receiving-email-receipt-rules-console-walkthrough.html). These receipt rules specify which addresses belong to each of your local users.

When an incoming email matches a user's receipt rule, the message object is placed into an S3 bucket with their username as its prefix. Additionally, a message is posted to an SNS topic to indicate that new mail has been received.

A Python CGI script running on apache-based container [coreybraun/ses-to-lmtp](https://hub.docker.com/r/coreybraun/ses-to-lmtp) acts as an HTTPS endpoint for the aforementioned SNS topic. Upon recieving an SNS notification, the CGI script calls another python script, `process-new-mail.py`.

This mail processing Python script uses [AWS's Boto3 module](https://boto3.amazonaws.com/v1/documentation/api/latest/index.html) to interact with your S3 mail bucket.
It first lists all objects in the bucket, adding any new messages (those without prefix 'processed/') to a list.
Next, it iterates over this list, taking the following steps for each message object:
1. Based on its prefix, decide which local user the message is for (i.e. object `user/message` is for `user`).
2. Get the object's contents as an [EmailMessage](https://docs.python.org/3/library/email.message.html) object.
3. Save the `Return-Path` header as a variable and remove it from the message (as to not duplicate it in the next step).
4. Send the message to Dovecot via LMTP using [smtplib module's **sendmail()** method](https://docs.python.org/3/library/smtplib.html#smtplib.SMTP.sendmail) over a Docker network.
5. Depending on the container's configuration, move the message to the `processed/` prefix (where it will expire after a set amount of days), or delete it.

If the script encounters an error during these steps, the problem is output to the container's logs and the script moves on to the next object (if any remain).

This script is also run when the contaniner starts, processing any emails that may have been recieved during its downtime.

The Dovecot container these messages are delivered to uses image [dovecot/dovecot](https://hub.docker.com/r/dovecot/dovecot/). This container acts as a standard IMAP server for your mail client.

## Requirements
To deploy this solution, you will need the following:
- An AWS account
- A domain name which you can edit DNS records for
- A linux server, which
  - has [Docker and Docker Compose](https://docs.docker.com/engine/install/) installed
  - has an A/AAAA DNS record pointing to it
  - has an SSL cert, signed by a trusted CA, for this DNS entry
  - you have the ability to open ports on
- A place to store user mailboxes, either
  - A directory in a locally-mounted filesystem on your linux server
  - An NFS share mountable by your linux server

Besides these requirements, some level of familiarity with Docker and AWS is expected.
Relevant documentation for each of these platforms is linked throughout this README for those who wish to learn more.

If you need a domain name, I can recommend [Porkbun](https://porkbun.com/) as a registrar. I have several domains registed through Porkbun, and have had a good experience registering/renewing with them as well as using their nameservers.

If you need an SSL cert, you should look into [Let's Encrypt](https://letsencrypt.org/) and an [ACME client](https://letsencrypt.org/docs/client-options/), such as [Certbot](https://certbot.eff.org/).

Your method of opening ports will vary depending on how your linux server is hosted. If your linux server is a VPS, look into your provider's method of opening ports.

If you're hosting the server yourself in a typical network, you will need to allow public access to each port from your firewall/router. If using IPv4, you will also typically need to create inbound NAT mappings (aka port forwards) on your router which point to your linux server's private IP.

## Deployment
To use this email server, you will need to deploy several AWS CloudFormation templates and Docker containers.

For convenience, pre-built docker images from this repository are publicly available on [Docker Hub](https://hub.docker.com/), with image tags:
- [coreybraun/ses-to-lmtp](https://hub.docker.com/r/coreybraun/ses-to-lmtp)
- [coreybraun/postfix-ses-relay](https://hub.docker.com/r/coreybraun/postfix-ses-relay)

The CloudFormation templates from this repository are also publicly available in S3 for easy deployment:
- [main.yaml](https://corey-braun-cloudformation.s3.amazonaws.com/hybrid-cloud-email/v1/main.yaml)
- [receipt-rule.yaml](https://corey-braun-cloudformation.s3.amazonaws.com/hybrid-cloud-email/v1/receipt-rule.yaml)
- [sns-subscription.yaml](https://corey-braun-cloudformation.s3.amazonaws.com/hybrid-cloud-email/v1/sns-subscription.yaml)

The instructions in this section will assume you are using the templates/images linked above.

It is recommended to deploy the `main.yaml` CloudFormation template before any docker containers.
If you choose to deploy your docker containers first, you must temporarily supply suitable dummy values for env vars `MAIL_BUCKET` and `AWS_CREDENTIALS[_FILE]`.
If these variables are empty or incorrectly formatted, containers `ses-to-lmtp` and `postfix-ses-relay` will exit due to misconfiguration.

### AWS
This section will walk through the process of deploying each of this solution's CloudFormation templates from the [AWS Web Management Console](https://docs.aws.amazon.com/awsconsolehelpdocs/latest/gsg/learn-whats-new.html).

Each template's sub-section will include a "Launch with AWS" button to deploy the template from S3. These sub-sections will also briefly cover the resources the template creates, as well as what they do.

When deploying these templates, you must do so in a [region SES supports email receiving in](https://docs.aws.amazon.com/ses/latest/dg/regions.html#region-receive-email).
In the web console, you can check/change your region on the right side of the top navigation bar, just left of your account's username.

Each template has several parameters you must specify; these will determine what resources get created, or how created resources are configured.

#### main.yaml
[![Launch with AWS](https://docs.aws.amazon.com/images/AmazonCloudFront/latest/DeveloperGuide/images/launch-on-aws-button.png)](https://console.aws.amazon.com/cloudformation/home#/stacks/new?stackName=CloudMailStack&templateURL=https://corey-braun-cloudformation.s3.amazonaws.com/hybrid-cloud-email/v1/main.yaml)

This template should be deployed first, as the other templates depend on resource(s) it creates.
The names or ARNs of these resources are exported in this template's outputs for other templates to reference.

This template uses the [AWS::LanguageExtensions transform](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/transform-aws-languageextensions.html) to [scale the template's created resources and outputs](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/intrinsic-function-reference-foreach.html) based on how many domains you specify in parameter _MailDomains_.
Because of this, deploying this template requires the additional capability `CAPABILITY_AUTO_EXPAND`.
When deploying from the web console, this means you will have to confirm using this capability at the bottom of the final "Review" step.

This template deploys most of the AWS resources for this solution, including:
- An S3 bucket to store received emails
- A bucket policy allowing SES to put objects in your mail bucket
- An SNS topic to post to when new mail is received
- A verified identity for each of your domains
- A receipt rule set for users' receipt rules
- An IAM user with permissions to send mail and process received mail (for your Docker containers)

After deploying this stack, there are a few manual steps you must take.

From the resources page of the stack, click the link to your SesReceiptRuleSet. On this page, you will need to click the `Set as active` button in the top right. Since only one receipt rule set can be active on your account in each region, this cannot be done automatically with CloudFormation.

Back at the resources page of the stack, click the link to your IamMailUser. On this page, click `Security credentials`, then `Create access key`. Select use case "Other", then finish the creation dialog. Save the "Access key" and "Secret access key" generated here, as you will need them when you deploy your docker containers.

Returning to the stack screen, click the "Outputs" tab this time. For each domain you are using, there should be 4 output keys containing "DnsRecord" (or 6, if you provided a MailFromSubDomain). For each of these keys, you will need to create the record in the "Value" column.

Each record is formatted as follows:
```
<[sub.]domain.tld> <TYPE> <Value>
```
With some DNS providers, the "10" in each MX record's value may need to be entered in a separate "Priority" field, rather than included in the Value/Answer section.

After creating these DNS records, you can check to see if AWS has verified them [here](https://console.aws.amazon.com/ses/home#/verified-identities).
Keep in mind that it will take time for your DNS records to propagate and be checked by AWS.

#### receipt-rule.yaml
[![Launch with AWS](https://docs.aws.amazon.com/images/AmazonCloudFront/latest/DeveloperGuide/images/launch-on-aws-button.png)](https://console.aws.amazon.com/cloudformation/home#/stacks/new?stackName=userReceiptRule&templateURL=https://corey-braun-cloudformation.s3.amazonaws.com/hybrid-cloud-email/v1/receipt-rule.yaml)

One instance of this template should be deployed per email user. Each instance will create a receipt rule which puts any message matching parameter _RecipientConditions_ into your mail bucket under prefix "_UserName_/". Additionally, each receipt rule will post a notification to your SNS new mail topic when matched.

The receipt rules in your rule set are evaluated in order. When created, new rules are placed at the beginning of the list. Therefore, rules are evaluated from latest creation date to earliest creation date, by default. If you want to reorder your rules, you can do so manually from your rule set after deployment.

For more information on recipient conditions and receipt rules, see [this AWS guide](https://docs.aws.amazon.com/ses/latest/dg/receiving-email-receipt-rules-console-walkthrough.html).

#### sns-subscription.yaml
[![Launch with AWS](https://docs.aws.amazon.com/images/AmazonCloudFront/latest/DeveloperGuide/images/launch-on-aws-button.png)](https://console.aws.amazon.com/cloudformation/home#/stacks/new?stackName=SnsMailEndpointSubscription&templateURL=https://corey-braun-cloudformation.s3.amazonaws.com/hybrid-cloud-email/v1/sns-subscription.yaml)

This template is used to subscribe your HTTPS endpoint on docker container `ses-to-lmtp` to your SNS new mail topic.
If sending the subscription message to your HTTPS endpoint fails, there is no way to manually force SNS to send it again.
Therefore, it is strongly recommended that you deploy your `ses-to-lmtp` container and verify it can be reached from the internet prior to deploying this template.

Special characters in parameters _BasicAuthPass_ and _BasicAuthUser_ must be [percent encoded](https://en.wikipedia.org/wiki/Percent-encoding).

### Docker
This section will walk through the process of deploying this solution's Docker containers using Docker Compose. Before starting, be sure your linux server meets the criteria in the [Requirements section](#requirements). All commands listed here should be run as root.

Using a [.env file](https://docs.docker.com/compose/environment-variables/set-environment-variables/#substitute-with-an-env-file) and [docker secrets](https://docs.docker.com/compose/use-secrets/), most standard configuration can be provided without editing the included `docker-compose.yml` file.
For simplicity, this section will cover configuration almost entirely using these methods.

First, clone the repository, cd into it, and copy `.env.example` to `.env`:
```
git clone https://github.com/corey-braun/hybrid-cloud-email
cd hybrid-cloud-email
cp .env.example .env
```

It is recommended that you pull/build your container images now, as they will be used to hash passwords for your docker secrets later.
To pull all three images, you can run `docker compose pull`.
If you want to build `coreybraun/ses-to-lmtp` and `coreybraun/postfix-ses-relay` yourself, you can run these commands instead:
```
docker compose build
docker pull dovecot/dovecot
```

Next, open `.env` in a text editor. The comments in this file explain how to configure each variable, but configuring your mailbox storage warrants some additional explanation.

If storing your user mailboxes in an NFS share, you just need to set the following variables in `.env`:
- `NFS_SERVER`
- `NFS_VERSION`
- `NFS_PATH`

If using a local volume for user mailbox storage, you first need to comment each of the above variables. Next, change `MAIL_VOLUME` from `nfs-mail-storage` to a local path you want to store mailboxes in (do not include a trailing slash in this path). Finally, you'll need to edit `docker-compose.yml` to comment the `volumes:` section:
```
#volumes:
#  nfs-mail-storage:
#    driver: local
#    driver_opts:
#      type: "nfs"
#      o: "addr=${NFS_SERVER},nfsvers=${NFS_VERSION}"
#      device: ":${NFS_PATH}"
```

Once you're done configuring `.env` you'll need to create your docker secret files to pass sensitive information to your containers.
Assuming you're using the default secrets path, use the following commands to create your secrets folder and files, as well as apply appropriate permissions to each:
```
mkdir secrets
touch secrets/dovecot_passwd secrets/sns_passwd secrets/aws_access_key
chmod -R go-rwx secrets/
chown 101 secrets/dovecot_passwd
```

`dovecot_passwd` is used to authenticate user mail clients when they connect to dovecot or postfix.
Each line should be formatted as follows (must include trailing colons):
```
username:{SCHEME}hashed_password::
```

To generate this password hash, you can use dovecot's `doveadm pw` utility in a temporary container:
```
docker run --rm -it dovecot/dovecot doveadm pw
```

`sns_passwd` is used to validate the credentials SNS uses for basic auth.
The contents of this file can be generated using apache's `htpasswd` utility in a temporary container:
```
docker run --rm -it coreybraun/ses-to-lmtp htpasswd -nB sns
```

If using a non-default username for basic auth, replace `sns` with the username you want to use.

`aws_access_key` is used to get mail from your S3 bucket, and to generate SMTP credentials allowing postfix to submit mail to SES.
The contents of this file should be in the following format:
```
access_key:secret_access_key
```

These values should have been generated earlier when you [deployed your main CloudFormation stack](#mainyaml).

Once you've finished configuring your `.env` and secret files, you are ready to start your containers.
You can do so with command `docker compose up -d`.

To view the logs of your containers, you can run `docker logs <container_name>`.

### Moving out of the SES sandbox
Upon initial deployment, your account will still be in the Amazon SES sandbox.
Until you manually request to move out of the sandbox, [certain restrictions](https://docs.aws.amazon.com/ses/latest/dg/request-production-access.html) will be imposed on your usage of SES, most notably:
- You can only send mail to verified email addresses and domains, or to [the Amazon SES mailbox simulator](https://docs.aws.amazon.com/ses/latest/dg/send-an-email-from-console.html#send-email-simulator).

Once you've finished deploying, configuring, and testing this solution, you will likely want to request production access to SES. To do so from the AWS Management Console, visit the following page:</br>
https://console.aws.amazon.com/ses/home#/get-set-up

After following the link above, make sure you have the correct AWS region selected in the console (the same one you deployed your resources in with CloudFormation).

From here, you should be able to click the `Request production access` button, after which you'll have to fill out a form explaining how you plan to use SES. This can be somewhat awkward since the form asks questions intended for businesses sending bulk marketing/transactional emails, so just do your best to explain your use case of sending/receiving personal email.

After filling out the form, you may receieve an automated response starting like this:
> Hello,
>
> Thank you for submitting your request to increase your sending limits. We would like to gather more information about your use case.

If so, try to provide any additional information requested.

After requesting production access, you should receive a response within 24 hours, hopefully telling you that your account has been moved out of the SES sandbox.

## Pricing
This section goes over the AWS resources deployed with this solution which Amazon may bill you for.

In this solution, billable resources are deployed from 3 different AWS categories. Linked below are the pricing pages for each:
- [Amazon Simple Email Serivce (SES)](https://aws.amazon.com/ses/pricing/)
- [Amazon Simple Notification Service (SNS)](https://aws.amazon.com/sns/pricing/)
- [Amazon S3](https://aws.amazon.com/s3/pricing/)

This section was last updated 11/12/2023.
Since AWS's pricing and billing policies may change in the future, you should verify any information discussed here for yourself.
You alone are liable for the cost of any AWS resources you use, so be sure to consult the pages linked above for complete and up-to-date pricing information.

### SES
With SES, you are charged per message you send or recieve, each counting as one message charge.
Sending to multiple recipients (CC/BCC) incurs one message charge per recipient.

You are additionally charged for the amount of data sent/recieved in messages.
The size of each message includes headers, content, and attachments.
Rates for sent and received data are different

This table shows SES's rates at the time of writing:
| Charge Type | Unit | Price |
| --- | --- | --- |
| Message charge | 1000 | $0.10 |
| Incoming data | 1GB | $0.36 |
| Outgoing data | 1GB | $0.12 |

SES's free tier is available for your first 12 months using it, during which your first 3000 message charges per month are free.
You will still be charged for all incoming/outgoing data in these messages.

### SNS
Each time an email matching your receipt rules is received by SNS, a notification is posted to an SNS topic.
This notification is then delivered to your HTTPS endpoint on docker container `ses-to-lmtp`.

1,000,000 messages can be posted to SNS topics for free per month. Therefore, this charge will be zero for most users.

Delivering messages to an HTTPS endpoint costs $0.60 per 1,000,000 messages. With the free tier, your first 100,000 HTTPS endpoint deliveries are free.
After the free tier, the cost will likely remain near-zero for most users due to the low price per message.

### S3
Email files are stored in an S3 bucket after being received by SNS.
Soon after, their contents are pulled by docker container `ses-to-lmtp`, then locally delivered to dovecot using LMTP.
Finally, each message is either deleted from the bucket, or moved to the `processed/` prefix (where they expire after a configurable amount of days, default 14).

The first 100GB of data transferred out of S3 is free.
Therefore, this charge will be zero for most users.

Storing data in S3 costs $0.023 per GB, per month.
If immediately deleting emails after processing them, this charge will be near-zero.
If moving emails to the `processed/` prefix, this charge will depend on how long messages are kept for, but would typically still be quite low.
